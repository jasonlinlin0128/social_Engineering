<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF æ¸¬è©¦è¨ºæ–·é é¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      font-size: 14px;
    }

    .container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
      text-align: center;
    }

    .log-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .log-section h3 {
      font-size: 14px;
      color: #667eea;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .log-item {
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
      font-size: 13px;
      word-break: break-all;
    }

    .log-item:last-child {
      border-bottom: none;
    }

    .label {
      font-weight: 600;
      color: #495057;
      display: inline-block;
      width: 120px;
    }

    .value {
      color: #212529;
    }

    .success {
      color: #28a745;
      font-weight: 600;
    }

    .error {
      color: #dc3545;
      font-weight: 600;
    }

    .warning {
      color: #ffc107;
      font-weight: 600;
    }

    .info {
      background: #d1ecf1;
      border-left-color: #0c5460;
      color: #0c5460;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 12px;
      line-height: 1.6;
    }

    .step {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
    }

    button:active {
      background: #5568d3;
    }

    .json-display {
      background: #263238;
      color: #aed581;
      padding: 12px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” LIFF æ¸¬è©¦è¨ºæ–·é é¢</h1>

    <div class="info">
      ğŸ“± æ­¤é é¢æœƒç›´æ¥åœ¨ç•«é¢ä¸Šé¡¯ç¤ºæ‰€æœ‰æ¸¬è©¦è³‡è¨Šï¼Œä¸éœ€è¦æŸ¥çœ‹ Console
    </div>

    <div id="debugInfo">
      <div class="loading">â³ æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <button onclick="location.reload()">ğŸ”„ é‡æ–°æ¸¬è©¦</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008536456-eRYM8pMv';
    const API_URL = window.location.origin;

    let debugLogs = [];

    function addLog(section, label, value, type = 'normal') {
      debugLogs.push({ section, label, value, type });
      renderDebugInfo();
    }

    function renderDebugInfo() {
      const sections = {};

      debugLogs.forEach(log => {
        if (!sections[log.section]) {
          sections[log.section] = [];
        }
        sections[log.section].push(log);
      });

      let html = '';
      for (const [sectionName, logs] of Object.entries(sections)) {
        html += `
          <div class="log-section">
            <h3>${sectionName}</h3>
        `;

        logs.forEach(log => {
          const valueClass = log.type === 'success' ? 'success' :
                           log.type === 'error' ? 'error' :
                           log.type === 'warning' ? 'warning' : 'value';

          html += `
            <div class="log-item">
              <span class="label">${log.label}:</span>
              <span class="${valueClass}">${log.value}</span>
            </div>
          `;
        });

        html += `</div>`;
      }

      document.getElementById('debugInfo').innerHTML = html;
    }

    async function testLiff() {
      try {
        // Step 1: æª¢æŸ¥åŸºæœ¬è³‡è¨Š
        addLog('1ï¸âƒ£ åŸºæœ¬è³‡è¨Š', 'LIFF ID', LIFF_ID);
        addLog('1ï¸âƒ£ åŸºæœ¬è³‡è¨Š', 'API URL', API_URL);
        addLog('1ï¸âƒ£ åŸºæœ¬è³‡è¨Š', 'User Agent', navigator.userAgent);
        addLog('1ï¸âƒ£ åŸºæœ¬è³‡è¨Š', 'ç•¶å‰æ™‚é–“', new Date().toLocaleString('zh-TW'));
        addLog('1ï¸âƒ£ åŸºæœ¬è³‡è¨Š', 'é é¢ç¶²å€', window.location.href);

        // Step 2: æª¢æŸ¥ LIFF SDK
        addLog('2ï¸âƒ£ LIFF SDK', 'SDK è¼‰å…¥ç‹€æ…‹', typeof liff !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥', typeof liff !== 'undefined' ? 'success' : 'error');

        if (typeof liff === 'undefined') {
          addLog('2ï¸âƒ£ LIFF SDK', 'éŒ¯èª¤èªªæ˜', 'LIFF SDK æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          return;
        }

        // Step 3: åˆå§‹åŒ– LIFF (åŠ å…¥è¶…æ™‚æª¢æ¸¬)
        addLog('3ï¸âƒ£ LIFF åˆå§‹åŒ–', 'é–‹å§‹åˆå§‹åŒ–', 'æ­£åœ¨åˆå§‹åŒ– LIFF...');

        // å‰µå»ºè¶…æ™‚ Promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('LIFF åˆå§‹åŒ–è¶…æ™‚ï¼ˆ10ç§’ï¼‰')), 10000);
        });

        // ä½¿ç”¨ Promise.race ä¾†æª¢æ¸¬è¶…æ™‚
        await Promise.race([
          liff.init({ liffId: LIFF_ID }),
          timeoutPromise
        ]);

        addLog('3ï¸âƒ£ LIFF åˆå§‹åŒ–', 'åˆå§‹åŒ–çµæœ', 'âœ… æˆåŠŸ', 'success');
        addLog('3ï¸âƒ£ LIFF åˆå§‹åŒ–', 'è€—æ™‚', 'æ­£å¸¸ï¼ˆ< 10ç§’ï¼‰', 'success');

        // Step 4: æª¢æŸ¥ç’°å¢ƒ
        const isInClient = liff.isInClient();
        addLog('4ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥', 'æ˜¯å¦åœ¨ LINE ä¸­', isInClient ? 'âœ… æ˜¯' : 'âŒ å¦', isInClient ? 'success' : 'error');

        const isLoggedIn = liff.isLoggedIn();
        addLog('4ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥', 'ç™»å…¥ç‹€æ…‹', isLoggedIn ? 'âœ… å·²ç™»å…¥' : 'âŒ æœªç™»å…¥', isLoggedIn ? 'success' : 'warning');

        if (!isInClient) {
          addLog('4ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥', 'âš ï¸ è­¦å‘Š', 'è«‹åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤é€£çµ', 'warning');
          addLog('4ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥', 'æ­£ç¢ºæ–¹å¼', 'åœ¨ LINE èŠå¤©å®¤ä¸­é»æ“Šé€£çµ', 'warning');
        }

        if (!isLoggedIn) {
          addLog('4ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥', 'è™•ç†æ–¹å¼', 'æ­£åœ¨å°å‘ç™»å…¥é é¢...', 'warning');
          setTimeout(() => {
            liff.login();
          }, 2000);
          return;
        }

        // Step 5: ç²å–ç”¨æˆ¶è³‡æ–™ (åŠ å…¥è¶…æ™‚æª¢æ¸¬)
        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'ç‹€æ…‹', 'æ­£åœ¨ç²å–ç”¨æˆ¶è³‡æ–™...');

        const profileTimeout = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('ç²å–ç”¨æˆ¶è³‡æ–™è¶…æ™‚ï¼ˆ10ç§’ï¼‰')), 10000);
        });

        const profile = await Promise.race([
          liff.getProfile(),
          profileTimeout
        ]);

        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'ç²å–çµæœ', 'âœ… æˆåŠŸ', 'success');
        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'User ID', profile.userId || 'ç„¡');
        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'é¡¯ç¤ºåç¨±', profile.displayName || 'ç„¡');
        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'é ­åƒ URL', profile.pictureUrl ? 'æœ‰' : 'ç„¡');
        addLog('5ï¸âƒ£ ç”¨æˆ¶è³‡æ–™', 'ç‹€æ…‹è¨Šæ¯', profile.statusMessage || 'ç„¡');

        // é¡¯ç¤ºå®Œæ•´ JSON
        const jsonSection = `
          <div class="log-section">
            <h3>ğŸ“‹ å®Œæ•´ç”¨æˆ¶è³‡æ–™ (JSON)</h3>
            <div class="json-display">${JSON.stringify(profile, null, 2)}</div>
          </div>
        `;
        document.getElementById('debugInfo').innerHTML += jsonSection;

        // Step 6: æ¸¬è©¦ API (åŠ å…¥è¶…æ™‚æª¢æ¸¬)
        addLog('6ï¸âƒ£ API æ¸¬è©¦', 'ç‹€æ…‹', 'æ­£åœ¨è¨˜éŒ„é»æ“Š...');

        const fetchTimeout = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('API è«‹æ±‚è¶…æ™‚ï¼ˆ15ç§’ï¼‰')), 15000);
        });

        const response = await Promise.race([
          fetch(`${API_URL}/api/track`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: profile.userId || 'unknown',
              displayName: profile.displayName || 'æœªçŸ¥ç”¨æˆ¶',
              pictureUrl: profile.pictureUrl || '',
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent
            })
          }),
          fetchTimeout
        ]);

        const result = await response.json();

        addLog('6ï¸âƒ£ API æ¸¬è©¦', 'API å›æ‡‰', result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—', result.success ? 'success' : 'error');
        addLog('6ï¸âƒ£ API æ¸¬è©¦', 'è¨Šæ¯', result.message);
        addLog('6ï¸âƒ£ API æ¸¬è©¦', 'HTTP ç‹€æ…‹', response.status);

        // é¡¯ç¤º API å›æ‡‰ JSON
        const apiJsonSection = `
          <div class="log-section">
            <h3>ğŸ“¡ API å›æ‡‰ (JSON)</h3>
            <div class="json-display">${JSON.stringify(result, null, 2)}</div>
          </div>
        `;
        document.getElementById('debugInfo').innerHTML += apiJsonSection;

        // Step 7: ç¸½çµ
        addLog('âœ… æ¸¬è©¦å®Œæˆ', 'çµè«–', 'æ‰€æœ‰æ¸¬è©¦é€šéï¼LIFF é‹ä½œæ­£å¸¸', 'success');
        addLog('âœ… æ¸¬è©¦å®Œæˆ', 'å»ºè­°', 'å¯ä»¥é–‹å§‹ä½¿ç”¨æ­£å¼ç‰ˆæœ¬äº†', 'success');

      } catch (error) {
        addLog('âŒ éŒ¯èª¤', 'éŒ¯èª¤é¡å‹', error.name || 'Unknown Error', 'error');
        addLog('âŒ éŒ¯èª¤', 'éŒ¯èª¤è¨Šæ¯', error.message || 'æœªçŸ¥éŒ¯èª¤', 'error');

        if (error.stack) {
          const stackSection = `
            <div class="log-section">
              <h3>ğŸ”´ éŒ¯èª¤å †ç–Š (Stack Trace)</h3>
              <div class="json-display">${error.stack}</div>
            </div>
          `;
          document.getElementById('debugInfo').innerHTML += stackSection;
        }

        // æ ¹æ“šéŒ¯èª¤é¡å‹çµ¦äºˆå»ºè­°
        if (error.message.includes('è¶…æ™‚')) {
          addLog('ğŸ’¡ è¨ºæ–·', 'å•é¡Œåˆ†æ', 'è«‹æ±‚è¶…æ™‚ï¼Œå¯èƒ½çš„åŸå› ï¼š', 'warning');

          if (error.message.includes('LIFF åˆå§‹åŒ–')) {
            addLog('ğŸ’¡ è¨ºæ–·', 'åŸå›  1', 'LIFF ID ä¸æ­£ç¢ºæˆ–ç„¡æ•ˆ', 'warning');
            addLog('ğŸ’¡ è¨ºæ–·', 'åŸå›  2', 'Endpoint URL èˆ‡å¯¦éš›ç¶²å€ä¸ç¬¦', 'warning');
            addLog('ğŸ’¡ è¨ºæ–·', 'åŸå›  3', 'ç¶²è·¯é€£ç·šå•é¡Œ', 'warning');
            addLog('ğŸ’¡ è¨ºæ–·', 'å»ºè­°', 'è«‹åˆ° LINE Developers Console ç¢ºèª LIFF è¨­å®š', 'warning');

            const diagSection = `
              <div class="log-section">
                <h3>ğŸ”§ æª¢æŸ¥æ¸…å–®</h3>
                <div class="json-display">
è«‹ç¢ºèªä»¥ä¸‹è¨­å®šï¼š

1. LINE Developers Console è¨­å®š
   LIFF ID: ${LIFF_ID}
   Endpoint URL: ${API_URL}/test.html

2. åœ¨ LINE Developers Console æª¢æŸ¥ï¼š
   - LIFF ID æ˜¯å¦æ­£ç¢º
   - Endpoint URL æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆåŒ…å« https://ï¼‰
   - Scope æ˜¯å¦åŒ…å« "profile"

3. ç›®å‰é é¢ç¶²å€ï¼š
   ${window.location.href}

   æ‡‰è©²ç­‰æ–¼ Endpoint URL
                </div>
              </div>
            `;
            document.getElementById('debugInfo').innerHTML += diagSection;
          } else if (error.message.includes('ç”¨æˆ¶è³‡æ–™')) {
            addLog('ğŸ’¡ è¨ºæ–·', 'åŸå› ', 'LINE ç™»å…¥ç‹€æ…‹ç•°å¸¸', 'warning');
            addLog('ğŸ’¡ è¨ºæ–·', 'å»ºè­°', 'è«‹é‡æ–°ç™»å…¥ LINE', 'warning');
          } else if (error.message.includes('API')) {
            addLog('ğŸ’¡ è¨ºæ–·', 'åŸå› ', 'å¾Œç«¯ä¼ºæœå™¨ç„¡å›æ‡‰', 'warning');
            addLog('ğŸ’¡ è¨ºæ–·', 'å»ºè­°', 'è«‹æª¢æŸ¥ Render éƒ¨ç½²ç‹€æ…‹', 'warning');
          }
        } else if (error.message.includes('LIFF ID')) {
          addLog('ğŸ’¡ å»ºè­°', 'è§£æ±ºæ–¹æ³•', 'è«‹æª¢æŸ¥ LIFF ID æ˜¯å¦æ­£ç¢º', 'warning');
        } else if (error.message.includes('login')) {
          addLog('ğŸ’¡ å»ºè­°', 'è§£æ±ºæ–¹æ³•', 'è«‹ç¢ºèªåœ¨ LINE ä¸­é–‹å•Ÿ', 'warning');
        } else if (error.message.includes('endpoint')) {
          addLog('ğŸ’¡ å»ºè­°', 'è§£æ±ºæ–¹æ³•', 'è«‹æª¢æŸ¥ Endpoint URL è¨­å®š', 'warning');
          addLog('ğŸ’¡ å»ºè­°', 'ç•¶å‰ç¶²å€', window.location.href, 'warning');
          addLog('ğŸ’¡ å»ºè­°', 'æ‡‰è©²è¨­å®šç‚º', API_URL + '/test.html', 'warning');
        }
      }
    }

    // å•Ÿå‹•æ¸¬è©¦
    window.addEventListener('load', () => {
      setTimeout(testLiff, 500);
    });
  </script>
</body>
</html>
