# 🔍 LIFF 問題診斷步驟

## 問題：用戶顯示 "unknown" 或 "未知用戶"

我已經建立了一個**測試診斷頁面**，可以直接在手機上看到所有除錯資訊，不需要查看 Console！

---

## 📱 測試步驟

### 步驟 1️⃣：建立測試用的 LIFF 應用（或更新現有的）

1. 前往 [LINE Developers Console](https://developers.line.biz/console/)
2. 找到你的 LIFF 應用
3. 點擊「Edit」編輯
4. **暫時**將 Endpoint URL 改為：
   ```
   https://你的網址/test.html
   ```
   例如：`https://your-app.onrender.com/test.html`
5. 確認 **Scope** 有勾選 `profile`
6. 儲存設定

### 步驟 2️⃣：在 LINE 中測試

1. 在 LINE 中打開「與自己的聊天」或任何聊天室
2. 傳送以下連結（使用你的 LIFF ID）：
   ```
   https://liff.line.me/2008536456-eRYM8pMv
   ```
3. **在 LINE 中點擊連結**（不要複製到瀏覽器）
4. 頁面會自動顯示測試結果

### 步驟 3️⃣：查看測試結果

頁面會顯示以下資訊：

#### ✅ 如果成功，你會看到：
```
1️⃣ 基本資訊
  LIFF ID: 2008536456-eRYM8pMv
  API URL: https://你的網址

2️⃣ LIFF SDK
  SDK 載入狀態: ✅ 已載入

3️⃣ LIFF 初始化
  初始化結果: ✅ 成功

4️⃣ 環境檢查
  是否在 LINE 中: ✅ 是
  登入狀態: ✅ 已登入

5️⃣ 用戶資料
  獲取結果: ✅ 成功
  User ID: U1234567890abcdef...
  顯示名稱: 你的名字
  頭像 URL: 有

📋 完整用戶資料 (JSON)
  {
    "userId": "U1234...",
    "displayName": "你的名字",
    "pictureUrl": "https://..."
  }

6️⃣ API 測試
  API 回應: ✅ 成功

✅ 測試完成
  結論: 所有測試通過！LIFF 運作正常
```

#### ❌ 如果失敗，你會看到錯誤訊息

常見錯誤：

**錯誤 1：不在 LINE 中**
```
4️⃣ 環境檢查
  是否在 LINE 中: ❌ 否
  ⚠️ 警告: 請在 LINE 應用程式中開啟此連結
```
**解決方法：** 必須在 LINE 聊天室中點擊連結

**錯誤 2：LIFF ID 錯誤**
```
❌ 錯誤
  錯誤訊息: LIFF ID is not valid
```
**解決方法：** 檢查 `public/test.html` 第 79 行的 LIFF ID 是否正確

**錯誤 3：Endpoint URL 不符**
```
❌ 錯誤
  錯誤訊息: Endpoint URL mismatch
```
**解決方法：** 在 LINE Developers Console 將 Endpoint URL 更新為 `https://你的網址/test.html`

**錯誤 4：未授權**
```
4️⃣ 環境檢查
  登入狀態: ❌ 未登入
```
**解決方法：** 頁面會自動導向登入，重新授權即可

---

## 📸 截圖方式

如果需要幫助，請截圖測試頁面的內容，特別是：
- ✅ 測試完成的部分
- ❌ 錯誤的部分
- 📋 完整用戶資料 (JSON) 的部分

---

## 🔧 完成測試後

### 如果測試**成功**：

1. 回到 LINE Developers Console
2. 將 Endpoint URL 改回正式版：
   ```
   https://你的網址/index.html
   ```
3. 儲存設定
4. 重新在 LINE 中測試正式版本
5. 應該就可以正常顯示用戶資訊了！

### 如果測試**失敗**：

根據錯誤訊息進行修正：

| 錯誤類型 | 檢查項目 |
|---------|---------|
| 不在 LINE 中 | 確認在 LINE 應用程式中開啟連結 |
| LIFF ID 錯誤 | 檢查 LIFF ID 是否正確 |
| Endpoint URL 不符 | 更新 LINE Developers Console 設定 |
| 未登入 | 重新授權 LIFF 應用 |
| API 錯誤 | 檢查後端是否正常運行 |

---

## 📊 檢查後端是否正常

在瀏覽器中開啟：
```
https://你的網址/api/stats
```

應該看到：
```json
{
  "success": true,
  "stats": {
    "totalClicks": 0,
    "uniqueUsers": 0,
    "lastClick": null
  }
}
```

如果看到錯誤或無法連接，代表後端有問題，需要檢查部署狀態。

---

## 🎯 快速診斷流程圖

```
開始測試
  ↓
在 LINE 中點擊 https://liff.line.me/你的LIFF_ID
  ↓
查看測試頁面
  ↓
是否顯示「SDK 載入狀態: ✅ 已載入」？
  ├─ ❌ → 檢查網路連線，重新整理
  └─ ✅ → 繼續
  ↓
是否顯示「是否在 LINE 中: ✅ 是」？
  ├─ ❌ → 必須在 LINE 中開啟，不能用瀏覽器
  └─ ✅ → 繼續
  ↓
是否顯示「初始化結果: ✅ 成功」？
  ├─ ❌ → 檢查 LIFF ID 和 Endpoint URL
  └─ ✅ → 繼續
  ↓
是否顯示「獲取結果: ✅ 成功」？
  ├─ ❌ → 檢查 Scope 是否包含 profile
  └─ ✅ → 成功！
  ↓
看到你的名字和 User ID
  ↓
測試完成！LIFF 運作正常
```

---

## 💬 需要幫助？

如果按照以上步驟仍無法解決，請提供：

1. ✅ 測試頁面的截圖（完整畫面）
2. ✅ 使用的裝置（iPhone / Android）
3. ✅ LINE 版本號
4. ✅ 是否有看到任何錯誤訊息

---

## 🔗 相關連結

- 測試頁面：`https://你的網址/test.html`
- 正式頁面：`https://你的網址/index.html`
- 管理後台：`https://你的網址/admin.html`
- API 測試：`https://你的網址/api/stats`
- LINE Developers：https://developers.line.biz/console/

---

## 📝 提醒

測試完成後，記得將 Endpoint URL 改回正式版本 `index.html`！
